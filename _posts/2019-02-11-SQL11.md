---
title: "SQL :eleven: Operation & Optimization"
date: 2019-02-01
tags: []
excerpt: "System commands, Error Handling, SCD's & Other"
mathjax: true
---

This is the eight in a series of SQL notes I made during the [Kubrick](https://kubrickgroup.com/) Data Engineering training course. The others are:  
[#1: Database Design]({{ site.url }}{{ site.baseurl }}/SQL1)  
[#2: SQL Design]({{ site.url }}{{ site.baseurl }}/SQL2)  
[#3: DQL]({{ site.url }}{{ site.baseurl }}/SQL3)  
[#4: DDL]({{ site.url }}{{ site.baseurl }}/SQL4)  
[#5: DML]({{ site.url }}{{ site.baseurl }}/SQL5)  
[#6: Sorting]({{ site.url }}{{ site.baseurl }}/SQL6)  
[#7: Joining]({{ site.url }}{{ site.baseurl }}/SQL7)  
[#8: Temporary Tables]({{ site.url }}{{ site.baseurl }}/SQL8)  
[#9: Programmable Objects]({{ site.url }}{{ site.baseurl }}/SQL9)  
[#10: Indexing]({{ site.url }}{{ site.baseurl }}/SQL10)  

All the posts in this series are my personal note taking and may be updated as the course progresses.  

---
# System commands  
### System Information  
- `sys.dm_db_index_usage_stats` - Shows usage stats for all indexes  
- `sys.dm_db_index_physical_stats` - Shows physical stats for all indexes  

### Database Console Commands  
`DBCC` statements allow a user to write a ‘console command’ which controls the database in some high level way. Commands can be grouped into **Maintanence**, **Miscellaneous**, **Informational**, and **Validation**.  
An example would `SHOW_STATISTICS` which shows key figures for a supplied table.  
```SQL
DBCC SHOW_STATISTICS('Sales.SalesOrderDetail')
```  


# Error Handling  
The following script will return an error code for the current transaction (0 is no error)  

```SQL
SELECT @@ERROR
```  

The following script will create `log_table`, attempt to divide by 0 and if (when) it fails, print the `ERROR_MESSAGE()` and insert it into the `log_table`.  

```SQL
CREATE TABLE log_table(error_msg NVARCHAR(500))

BEGIN TRAN
DECLARE @denom FLOAT = 0
BEGIN TRY
	SELECT 500/@denom
END TRY
BEGIN CATCH
	PRINT 'uh oh, ' + ERROR_MESSAGE()  
	ROLLBACK TRAN
	INSERT INTO log_table (error_msg)  -- Log error
	SELECT ERROR_MESSAGE()
END CATCH
```  

# Statistics  
`SET STATISTICS IO ON` before an operation will display the scan count, logical reads, physical reads and more of the operation in the messages tab.  
`SET STATISTICS TIME ON` displays the CPU and elapsed time for an operation to complete.  

# Slowly Changing Dimensions  