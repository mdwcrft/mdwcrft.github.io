---
title: "SQL :one::one: Operation & Optimization"
date: 2019-02-01
tags: []
excerpt: "System commands, Error Handling, SCD's & Other"
mathjax: true
---

This is the eight in a series of SQL notes I made during the [Kubrick](https://kubrickgroup.com/) Data Engineering training course. The others are:  
[#1: Database Design]({{ site.url }}{{ site.baseurl }}/SQL1)  
[#2: SQL Design]({{ site.url }}{{ site.baseurl }}/SQL2)  
[#3: DQL]({{ site.url }}{{ site.baseurl }}/SQL3)  
[#4: DDL]({{ site.url }}{{ site.baseurl }}/SQL4)  
[#5: DML]({{ site.url }}{{ site.baseurl }}/SQL5)  
[#6: Sorting]({{ site.url }}{{ site.baseurl }}/SQL6)  
[#7: Joining]({{ site.url }}{{ site.baseurl }}/SQL7)  
[#8: Temporary Tables]({{ site.url }}{{ site.baseurl }}/SQL8)  
[#9: Programmable Objects]({{ site.url }}{{ site.baseurl }}/SQL9)  
[#10: Indexing]({{ site.url }}{{ site.baseurl }}/SQL10)  

All the posts in this series are my personal note taking and may be updated as the course progresses.  

---
# Transactions
A transaction is a sequence of operations performed as a single logical unit of work, which must adhere to ACID.  
It is the responsibility of the Database Engine, to provide mechanisms ensuring the physical integrity of each transaction. SQL programmers are responsible for starting and ending transactions at points that enforce the logical consistency of the data.  

### Transaction Isolation Levels
There are various levels of *transaction isolation* that can be set for a table or query.  
A query level can be set using `WITH (<LEVEL>)` for example; `SELECT * FROM Production.Product WITH (NOLOCK)` gives the query **READ UNCOMMITTED** access to the table.  
 
To set a global isolation level the syntax and options are;

```sql
SET TRANSACTION ISOLATION LEVEL 
    { READ UNCOMMITTED --Pessimistic 
    | READ COMMITTED   --DEFAULT 
    | REPEATABLE READ 
    | SNAPSHOT 
    | SERIALIZABLE  --Optimistic 
    }
```  

#### Read Uncommitted: 
Can read rows that have been modified by other transactions but not yet committed. 

#### Read Committed: 
Cannot read data that has been modified but not committed by other transactions. 

#### Repeatable Read: 
Cannot read data that has been modified but not yet committed by other transactions and that no other transactions can modify data that has been read by the current transaction until the current transaction completes. 

#### Snapshot: 
Data read by any statement in a transaction will be the transactionally consistent version of the data that existed at the start of the transaction. 

#### Serializable: 
Range locks are placed in the range of key values that match the search conditions of each statement executed in a transaction. This blocks other transactions from updating or inserting any rows that would qualify for any of the statements executed by the current transaction.  


# System commands  
### System Information  
- `sys.dm_db_index_usage_stats` - Shows usage stats for all indexes  
- `sys.dm_db_index_physical_stats` - Shows physical stats for all indexes  

### Database Console Commands  
`DBCC` statements allow a user to write a ‘console command’ which controls the database in some high level way. Commands can be grouped into **Maintanence**, **Miscellaneous**, **Informational**, and **Validation**.  
An example would `SHOW_STATISTICS` which shows key figures for a supplied table.  
```SQL
DBCC SHOW_STATISTICS('Sales.SalesOrderDetail')
```  


# Error Handling  
The following script will return an error code for the current transaction (0 is no error)  

```SQL
SELECT @@ERROR
```  

The following script will create `log_table`, attempt to divide by 0 and if (when) it fails, print the `ERROR_MESSAGE()` and insert it into the `log_table`.  

```SQL
CREATE TABLE log_table(error_msg NVARCHAR(500))

BEGIN TRAN
DECLARE @denom FLOAT = 0
BEGIN TRY
	SELECT 500/@denom
END TRY
BEGIN CATCH
	PRINT 'uh oh, ' + ERROR_MESSAGE()  
	ROLLBACK TRAN
	INSERT INTO log_table (error_msg)  -- Log error
	SELECT ERROR_MESSAGE()
END CATCH
```  

# Statistics  
`SET STATISTICS IO ON` before an operation will display the scan count, logical reads, physical reads and more of the operation in the messages tab.  
`SET STATISTICS TIME ON` displays the CPU and elapsed time for an operation to complete.  

# Slowly Changing Dimensions  